# Portrait Enhancement Pipeline

–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è –ø–æ—Ä—Ç—Ä–µ—Ç—ñ–≤ –∑ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è–º Stable Diffusion, ControlNet —Ç–∞ ADetailer.

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ—î–∫—Ç—É

```
ADetailer_2CN/
‚îú‚îÄ‚îÄ README.md                 # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è –ø—Ä–æ—î–∫—Ç—É
‚îú‚îÄ‚îÄ bootstrap.sh              # –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–∞ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
‚îú‚îÄ‚îÄ models_auto.py            # –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –º–æ–¥–µ–ª–µ–π
‚îú‚îÄ‚îÄ Dockerfile                # Docker –æ–±—Ä–∞–∑ –¥–ª—è —Ä–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è
‚îú‚îÄ‚îÄ docker-compose.yml        # Docker Compose –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è
‚îú‚îÄ‚îÄ deploy_vast.sh            # –°–∫—Ä–∏–ø—Ç —Ä–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è –Ω–∞ vast.ai
‚îú‚îÄ‚îÄ upload_images.sh          # –°–∫—Ä–∏–ø—Ç –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–æ–±—Ä–∞–∂–µ–Ω—å
‚îú‚îÄ‚îÄ download_results.sh       # –°–∫—Ä–∏–ø—Ç –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤
‚îú‚îÄ‚îÄ monitor.sh                # –°–∫—Ä–∏–ø—Ç –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É
‚îú‚îÄ‚îÄ portrait-enhancer/        # –û—Å–Ω–æ–≤–Ω–∏–π –º–æ–¥—É–ª—å –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è
‚îÇ   ‚îú‚îÄ‚îÄ config.yaml          # –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤
‚îÇ   ‚îú‚îÄ‚îÄ batch.py             # –ü–∞–∫–µ—Ç–Ω–∞ –æ–±—Ä–æ–±–∫–∞ –∑–æ–±—Ä–∞–∂–µ–Ω—å
‚îÇ   ‚îú‚îÄ‚îÄ run_a_pass.py        # –ü–µ—Ä—à–∏–π –ø—Ä–æ—Ö—ñ–¥ - —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –º–∞—Å–æ–∫ —Ç–∞ –∫–æ–Ω—Ç—É—Ä—ñ–≤
‚îÇ   ‚îú‚îÄ‚îÄ run_b_pass.py        # –î—Ä—É–≥–∏–π –ø—Ä–æ—Ö—ñ–¥ - AI –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è
‚îÇ   ‚îî‚îÄ‚îÄ requirements.txt     # –ó–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ Python
‚îî‚îÄ‚îÄ .gitignore               # Git —ñ–≥–Ω–æ—Ä—É–≤–∞–Ω–Ω—è
```

## –û—Å–Ω–æ–≤–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó

- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∞** Stable Diffusion WebUI —Ç–∞ —Ä–æ–∑—à–∏—Ä–µ–Ω—å
- **–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –º–æ–¥–µ–ª–µ–π** –∑ CivitAI
- **–°—Ç–≤–æ—Ä–µ–Ω–Ω—è –º–∞—Å–æ–∫** –æ–±–ª–∏—á—á—è —Ç–∞ –∫–æ–Ω—Ç—É—Ä–Ω–∏—Ö –∫–∞—Ä—Ç
- **AI –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è** –∑ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è–º ControlNet —Ç–∞ ADetailer
- **–ü–∞–∫–µ—Ç–Ω–∞ –æ–±—Ä–æ–±–∫–∞** –∑–æ–±—Ä–∞–∂–µ–Ω—å
- **–†–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è –Ω–∞ vast.ai** –∑ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü—ñ—î—é
- **üéØ ADetailer 2CN Plus** - —Ä–æ–∑—à–∏—Ä–µ–Ω–∞ –¥–µ—Ç–µ–∫—Ü—ñ—è –æ–±–ª–∏—á –∑ –º–Ω–æ–∂–∏–Ω–Ω–∏–º–∏ –¥–µ—Ç–µ–∫—Ç–æ—Ä–∞–º–∏

## –®–≤–∏–¥–∫–∏–π —Å—Ç–∞—Ä—Ç –Ω–∞ vast.ai

### 1. –ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ SSH —Ç—É–Ω–µ–ª—é
```bash
ssh -p 18826 root@ssh4.vast.ai -L 8080:localhost:8080
```

### 2. –†–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è –ø—Ä–æ–µ–∫—Ç—É
```bash
chmod +x deploy_vast.sh
./deploy_vast.sh
```

### 3. –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–æ–±—Ä–∞–∂–µ–Ω—å
```bash
chmod +x upload_images.sh
./upload_images.sh [—à–ª—è—Ö_–¥–æ_–∑–æ–±—Ä–∞–∂–µ–Ω—å]
```

### 4. –ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ—Ü–µ—Å—É
```bash
chmod +x monitor.sh
./monitor.sh
```

### 5. –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤
```bash
chmod +x download_results.sh
./download_results.sh
```

## –õ–æ–∫–∞–ª—å–Ω–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è

### 1. –ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ Docker
```bash
docker-compose up --build
```

### 2. –†—É—á–Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∞
```bash
chmod +x bootstrap.sh
./bootstrap.sh
```

## –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è

1. –ü–æ–º—ñ—Å—Ç—ñ—Ç—å –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –≤ –ø–∞–ø–∫—É `portrait-enhancer/input/`
2. –ó–∞–ø—É—Å—Ç—ñ—Ç—å `python batch.py` –¥–ª—è –æ–±—Ä–æ–±–∫–∏
3. –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –≤ `portrait-enhancer/output/`

## –¢–µ—Ö–Ω–æ–ª–æ–≥—ñ—ó

- **Stable Diffusion WebUI** - –æ—Å–Ω–æ–≤–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó
- **ControlNet** - –∫–æ–Ω—Ç—Ä–æ–ª—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è
- **ADetailer** - –¥–µ—Ç–∞–ª—ñ–∑–∞—Ü—ñ—è –æ–±–ª–∏—á—á—è
- **PIL/Pillow** - –æ–±—Ä–æ–±–∫–∞ –∑–æ–±—Ä–∞–∂–µ–Ω—å
- **PyYAML** - –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è
- **Docker** - –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü—ñ—è
- **vast.ai** - —Ö–º–∞—Ä–Ω–µ —Ä–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è

## üéØ ADetailer 2CN Plus

–ü—Ä–æ–µ–∫—Ç –≤–∫–ª—é—á–∞—î —Ä–æ–∑—à–∏—Ä–µ–Ω—É –≤–µ—Ä—Å—ñ—é ADetailer –∑ –ø–æ–∫—Ä–∞—â–µ–Ω–æ—é –¥–µ—Ç–µ–∫—Ü—ñ—î—é –æ–±–ª–∏—á:

### –ü–µ—Ä–µ–≤–∞–≥–∏:
- **–ú–Ω–æ–∂–∏–Ω–Ω—ñ –¥–µ—Ç–µ–∫—Ç–æ—Ä–∏**: BlazeFace (—à–≤–∏–¥–∫–∏–π), RetinaFace (—Ç–æ—á–Ω–∏–π), MTCNN (–∑–±–∞–ª–∞–Ω—Å–æ–≤–∞–Ω–∏–π)
- **Cascade detection**: –±–∞–≥–∞—Ç–æ–µ—Ç–∞–ø–Ω–∞ –¥–µ—Ç–µ–∫—Ü—ñ—è –¥–ª—è –∫—Ä–∞—â–æ—ó —Ç–æ—á–Ω–æ—Å—Ç—ñ
- **–†–æ–∑—à–∏—Ä–µ–Ω—ñ —Å—Ç—Ä–∞—Ç–µ–≥—ñ—ó –ø–æ—à—É–∫—É**: sliding window —Ç–∞ multi-scale –ø—ñ–¥—Ö–æ–¥–∏
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –≤–∏—Ä—ñ–≤–Ω—é–≤–∞–Ω–Ω—è –æ–±–ª–∏—á**: –¥–µ—Ç–µ–∫—Ü—ñ—è –∫–ª—é—á–æ–≤–∏—Ö —Ç–æ—á–æ–∫
- **–ü–æ–≤–Ω–∞ —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è** –∑ —ñ—Å–Ω—É—é—á–∏–º portrait-enhancer pipeline

### –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è:
```bash
# –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—ó
make test-ad2cn

# –†–æ–∑—à–∏—Ä–µ–Ω–∞ –æ–±—Ä–æ–±–∫–∞ –∑–æ–±—Ä–∞–∂–µ–Ω—å
python portrait-enhancer/enhanced_batch.py --use-ad2cn

# –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–∞ —Ä–æ–∑—à–∏—Ä–µ–Ω–∞ –æ–±—Ä–æ–±–∫–∞ –Ω–∞ vast.ai
make enhanced-upload
```

## –ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ —Ç–∞ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è

### –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å—É WebUI
```bash
ssh -p 18826 root@ssh4.vast.ai 'curl -s http://127.0.0.1:7860/sdapi/v1/sd-models'
```

### –ü—Ä–∏—î–¥–Ω–∞–Ω–Ω—è –¥–æ tmux —Å–µ—Å—ñ—ó
```bash
ssh -p 18826 root@ssh4.vast.ai 'tmux attach -t webui'
```

### –ó—É–ø–∏–Ω–∫–∞ –ø—Ä–æ—Ü–µ—Å—É
```bash
ssh -p 18826 root@ssh4.vast.ai 'tmux kill-session -t webui'
```

## –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è

–û—Å–Ω–æ–≤–Ω—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ –Ω–∞–ª–∞—à—Ç–æ–≤—É—é—Ç—å—Å—è –≤ `portrait-enhancer/config.yaml`:

- **ControlNet –º–æ–¥–µ–ª—ñ** - –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—é —Å—Ç—Ä—É–∫—Ç—É—Ä–∏
- **ADetailer –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è** - –¥–ª—è –¥–µ—Ç–∞–ª—ñ–∑–∞—Ü—ñ—ó –æ–±–ª–∏—á—á—è
- **–ü—Ä–æ–º–ø—Ç–∏** - –¥–ª—è –∫–µ—Ä—É–≤–∞–Ω–Ω—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º
- **–ü–∞—Ä–∞–º–µ—Ç—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó** - steps, CFG, denoise

## –ü—ñ–¥—Ç—Ä–∏–º—É–≤–∞–Ω—ñ —Ñ–æ—Ä–º–∞—Ç–∏

- **–í—Ö—ñ–¥–Ω—ñ**: PNG, JPG, JPEG, WebP
- **–í–∏—Ö—ñ–¥–Ω—ñ**: PNG (–∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —è–∫–æ—Å—Ç—ñ)
- **–ú–æ–¥–µ–ª—ñ**: SafeTensors, CKPT
